// Package transport provides transport layer of the vulnerability scanner application.
// It includes NATS subscriber for consuming scanning task.
package transport

import (
	"context"

	"github.com/nats-io/nats.go"

	kitlog "github.com/go-kit/kit/log"
	natstransport "github.com/go-kit/kit/transport/nats"

	domain "github.com/lephuocmy668/vulnerability-scanner/domain"
	endpoint "github.com/lephuocmy668/vulnerability-scanner/endpoint"
)

// MakeTaskConsumer returns a NATS subscriber that consumes scanning task.
func MakeTaskConsumer(sc domain.ScannerService, logger kitlog.Logger) *natstransport.Subscriber {
	return natstransport.NewSubscriber(
		endpoint.MakeScanEndpoint(sc),
		DecodeScanRepoRequest,
		natstransport.EncodeJSONResponse,
	)
}

// DecodeScanRepoRequest is a NATS message decoder that decodes the incoming message into a string and returns it.
func DecodeScanRepoRequest(_ context.Context, msg *nats.Msg) (interface{}, error) {
	return string(msg.Data), nil
}
